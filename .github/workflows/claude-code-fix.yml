name: Claude Code Fix

on:
  # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ@claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
  issue_comment:
    types: [created]
  # PRã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
  pull_request_review_comment:
    types: [created]

jobs:
  claude-fix:
    # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ @claude ãŒãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Get PR information
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber, prHeadRef, prHeadSha;

            if (context.eventName === 'issue_comment') {
              // issue_comment ã®å ´åˆã¯PRæƒ…å ±ã‚’å–å¾—
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              prNumber = context.issue.number;
              prHeadRef = pr.data.head.ref;
              prHeadSha = pr.data.head.sha;
            } else {
              // pull_request_review_comment ã®å ´åˆ
              prNumber = context.payload.pull_request.number;
              prHeadRef = context.payload.pull_request.head.ref;
              prHeadSha = context.payload.pull_request.head.sha;
            }

            core.setOutput('pr_number', prNumber);
            core.setOutput('head_ref', prHeadRef);
            core.setOutput('head_sha', prHeadSha);

            console.log(`PR Number: ${prNumber}`);
            console.log(`Head Ref: ${prHeadRef}`);
            console.log(`Head SHA: ${prHeadSha}`);

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-info.outputs.head_ref }}
          fetch-depth: 0

      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'issue_comment') {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'eyes'
              });
            } else if (context.eventName === 'pull_request_review_comment') {
              await github.rest.reactions.createForPullRequestReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'eyes'
              });
            }

      - name: Create MCP config
        run: |
          cat > /tmp/mcp-config.json << 'MCPEOF'
          {
            "mcpServers": {
              "context7": {
                "command": "npx",
                "args": ["-y", "@upstash/context7-mcp"]
              }
            }
          }
          MCPEOF
        env:
          CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}

      - name: Build context for issue comment thread
        id: build-issue-context
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;

            // PRã®å…¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
            const allComments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });

            // ç¾åœ¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚ˆã‚Šå‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ï¼ˆç›´è¿‘10ä»¶ï¼‰
            const currentCommentIndex = allComments.data.findIndex(c => c.id === context.payload.comment.id);
            const recentComments = allComments.data.slice(Math.max(0, currentCommentIndex - 10), currentCommentIndex + 1);

            let contextInfo = '';
            if (recentComments.length > 1) {
              contextInfo = `
            ## PRã‚³ãƒ¡ãƒ³ãƒˆå±¥æ­´ï¼ˆç›´è¿‘ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
            `;
              for (const tc of recentComments) {
                const isCurrentComment = tc.id === context.payload.comment.id;
                const marker = isCurrentComment ? 'ğŸ‘‰ ' : '';
                contextInfo += `
            ### ${marker}@${tc.user.login} (${new Date(tc.created_at).toISOString()})
            ${tc.body}
            `;
              }

              contextInfo += `
            ---
            **æ³¨æ„**: ğŸ‘‰ ãƒãƒ¼ã‚¯ãŒä»Šå› @claude ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã§ã™ã€‚
            ã‚³ãƒ¡ãƒ³ãƒˆå±¥æ­´ã®æ–‡è„ˆã‚’ç†è§£ã—ãŸä¸Šã§ã€æŒ‡ç¤ºã«å¾“ã£ã¦å¯¾å¿œã—ã¦ãã ã•ã„ã€‚
            `;
            }

            core.setOutput('context_info', contextInfo);

      - name: Build context for inline comment
        id: build-context
        if: github.event_name == 'pull_request_review_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const filePath = comment.path;
            const line = comment.line || comment.original_line;
            const diffHunk = comment.diff_hunk;
            const prNumber = context.payload.pull_request.number;

            // è¦ªã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ã®å…ƒã‚³ãƒ¡ãƒ³ãƒˆï¼‰ã‚’å–å¾—
            let parentComment = null;
            let threadComments = [];

            if (comment.in_reply_to_id) {
              // è¿”ä¿¡ã‚³ãƒ¡ãƒ³ãƒˆã®å ´åˆã€PRã®å…¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã—ã¦ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æ§‹ç¯‰
              const allComments = await github.rest.pulls.listReviewComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                per_page: 100
              });

              // è¦ªã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã‚‹
              parentComment = allComments.data.find(c => c.id === comment.in_reply_to_id);

              if (parentComment) {
                // ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®å…¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ï¼ˆè¦ªã‚³ãƒ¡ãƒ³ãƒˆã¸ã®è¿”ä¿¡ï¼‰
                threadComments = allComments.data.filter(c =>
                  c.in_reply_to_id === parentComment.id || c.id === parentComment.id
                ).sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
              }
            }

            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’æ§‹ç¯‰
            let contextInfo = `
            ## ã‚³ãƒ¡ãƒ³ãƒˆä½ç½®æƒ…å ±
            - ãƒ•ã‚¡ã‚¤ãƒ«: ${filePath}
            - è¡Œç•ªå·: ${line}
            - Diff:
            \`\`\`diff
            ${diffHunk}
            \`\`\`
            `;

            // è¦ªã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯ã‚¹ãƒ¬ãƒƒãƒ‰å…¨ä½“ã‚’è¿½åŠ 
            if (parentComment) {
              contextInfo += `
            ## ã‚³ãƒ¡ãƒ³ãƒˆã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆå…ƒã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã¨è¿”ä¿¡ï¼‰
            `;
              for (const tc of threadComments) {
                const isCurrentComment = tc.id === comment.id;
                const marker = isCurrentComment ? 'ğŸ‘‰ ' : '';
                contextInfo += `
            ### ${marker}@${tc.user.login} (${new Date(tc.created_at).toISOString()})
            ${tc.body}
            `;
              }

              contextInfo += `
            ---
            **æ³¨æ„**: ä¸Šè¨˜ã‚¹ãƒ¬ãƒƒãƒ‰ã®æœ€åˆã®ã‚³ãƒ¡ãƒ³ãƒˆãŒå…ƒã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ã§ã™ã€‚ğŸ‘‰ ãƒãƒ¼ã‚¯ãŒä»Šå› @claude ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã§ã™ã€‚
            ã‚¹ãƒ¬ãƒƒãƒ‰å…¨ä½“ã®æ–‡è„ˆã‚’ç†è§£ã—ãŸä¸Šã§ã€æŒ‡ç¤ºã«å¾“ã£ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
            `;
            }

            core.setOutput('context_info', contextInfo);
            core.setOutput('file_path', filePath);
            core.setOutput('line_number', line);
            core.setOutput('has_parent', parentComment ? 'true' : 'false');

      - name: Run Claude Code Fix
        id: claude-fix
        uses: anthropics/claude-code-action@v1
        env:
          CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ## ã‚¿ã‚¹ã‚¯: ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã«åŸºã¥ãã‚³ãƒ¼ãƒ‰ä¿®æ­£

            ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã«å¾“ã£ã¦ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

            ### ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹
            ${{ github.event.comment.body }}

            ### ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿è€…
            ${{ github.event.comment.user.login }}

            ${{ github.event_name == 'pull_request_review_comment' && steps.build-context.outputs.context_info || '' }}
            ${{ github.event_name == 'issue_comment' && steps.build-issue-context.outputs.context_info || '' }}

            ### ä¿®æ­£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

            1. **ã‚³ãƒ¡ãƒ³ãƒˆã®æ„å›³ã‚’ç†è§£ã™ã‚‹**
               - ã‚³ãƒ¡ãƒ³ãƒˆãŒæŒ‡æ‘˜ã—ã¦ã„ã‚‹å•é¡Œã‚’æ­£ç¢ºã«æŠŠæ¡
               - ä¿®æ­£ç¯„å›²ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹

            2. **ä¿®æ­£ã‚’å®Ÿæ–½**
               - æŒ‡æ‘˜ã•ã‚ŒãŸå•é¡Œã‚’ä¿®æ­£
               - é–¢é€£ã™ã‚‹ç®‡æ‰€ãŒã‚ã‚Œã°ä¸€ç·’ã«ä¿®æ­£
               - ãƒ†ã‚¹ãƒˆãŒå¿…è¦ãªå ´åˆã¯è¿½åŠ ãƒ»æ›´æ–°

            3. **å“è³ªãƒã‚§ãƒƒã‚¯**
               - ä¿®æ­£ãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¦ç´„ï¼ˆCLAUDE.mdã€.kiro/steering/ï¼‰ã«å¾“ã£ã¦ã„ã‚‹ã‹ç¢ºèª
               - TypeScriptã®å‹ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª
               - ãƒªãƒ³ã‚¿ãƒ¼ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª

            4. **å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ**
               - ä¿®æ­£ãŒå®Œäº†ã—ãŸã‚‰ã€ä»¥ä¸‹ã®å½¢å¼ã§ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ï¼š
               ```
               fix: [ä¿®æ­£å†…å®¹ã®ç°¡æ½”ãªèª¬æ˜]

               Addresses review comment by @${{ github.event.comment.user.login }}

               Co-Authored-By: Claude <noreply@anthropic.com>
               ```
               - `git push` ã§å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥

            5. **å®Œäº†å ±å‘Š**
               - ä¿®æ­£å®Œäº†å¾Œã€`gh pr comment` ã§PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã—ã¦ãã ã•ã„
               - ä½•ã‚’ä¿®æ­£ã—ãŸã‹ã€ä¿®æ­£ã®ç†ç”±ã‚’ç°¡æ½”ã«èª¬æ˜

            ### æ³¨æ„äº‹é …
            - `@claude` ä»¥é™ã®ãƒ†ã‚­ã‚¹ãƒˆãŒæŒ‡ç¤ºå†…å®¹ã§ã™
            - ä¸æ˜ç¢ºãªæŒ‡ç¤ºã®å ´åˆã¯ã€PRã«ã‚³ãƒ¡ãƒ³ãƒˆã§è³ªå•ã—ã¦ãã ã•ã„
            - ä¿®æ­£ã«è‡ªä¿¡ãŒãªã„å ´åˆã¯ã€ææ¡ˆã¨ã—ã¦è¿”ä¿¡ã—ã¦ãã ã•ã„
            - ç ´å£Šçš„ãªå¤‰æ›´ã‚„å¤§è¦æ¨¡ãªãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¯é¿ã‘ã¦ãã ã•ã„

            ### Gitæ“ä½œã®å³å®ˆäº‹é …ï¼ˆé•åç¦æ­¢ï¼‰
            - `git push --force`, `git push -f`, `git push --force-with-lease` ã¯çµ¶å¯¾ã«ä½¿ç”¨ç¦æ­¢
            - `git commit --amend` ã¯ä½¿ç”¨ç¦æ­¢ï¼ˆå¸¸ã«æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆï¼‰
            - `git reset --hard` ã¯ä½¿ç”¨ç¦æ­¢
            - `git rebase` ã¯ä½¿ç”¨ç¦æ­¢
            - main/master/develop ãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥ã¯ç¦æ­¢

          claude_args: '--mcp-config /tmp/mcp-config.json --allowed-tools "Bash(git status),Bash(git add:*),Bash(git commit -m:*),Bash(git push origin HEAD),Bash(git diff:*),Bash(gh pr comment:*),Bash(gh pr view:*),mcp__context7__*"'

      - name: Add success reaction
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            // Remove eyes reaction and add rocket
            const isIssueComment = context.eventName === 'issue_comment';

            try {
              let reactions;
              if (isIssueComment) {
                reactions = await github.rest.reactions.listForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.id
                });
              } else {
                reactions = await github.rest.reactions.listForPullRequestReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.id
                });
              }

              const eyesReaction = reactions.data.find(r => r.content === 'eyes' && r.user.login === 'github-actions[bot]');
              if (eyesReaction) {
                if (isIssueComment) {
                  await github.rest.reactions.deleteForIssueComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: context.payload.comment.id,
                    reaction_id: eyesReaction.id
                  });
                } else {
                  await github.rest.reactions.deleteForPullRequestReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: context.payload.comment.id,
                    reaction_id: eyesReaction.id
                  });
                }
              }
            } catch (e) {
              console.log('Could not remove eyes reaction:', e.message);
            }

            if (isIssueComment) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'rocket'
              });
            } else {
              await github.rest.reactions.createForPullRequestReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'rocket'
              });
            }

      - name: Add failure reaction
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Remove eyes reaction and add confused
            const isIssueComment = context.eventName === 'issue_comment';

            try {
              let reactions;
              if (isIssueComment) {
                reactions = await github.rest.reactions.listForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.id
                });
              } else {
                reactions = await github.rest.reactions.listForPullRequestReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.id
                });
              }

              const eyesReaction = reactions.data.find(r => r.content === 'eyes' && r.user.login === 'github-actions[bot]');
              if (eyesReaction) {
                if (isIssueComment) {
                  await github.rest.reactions.deleteForIssueComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: context.payload.comment.id,
                    reaction_id: eyesReaction.id
                  });
                } else {
                  await github.rest.reactions.deleteForPullRequestReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: context.payload.comment.id,
                    reaction_id: eyesReaction.id
                  });
                }
              }
            } catch (e) {
              console.log('Could not remove eyes reaction:', e.message);
            }

            if (isIssueComment) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'confused'
              });
            } else {
              await github.rest.reactions.createForPullRequestReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'confused'
              });
            }
