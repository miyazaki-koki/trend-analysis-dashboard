name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create MCP config
        run: |
          cat > /tmp/mcp-config.json << 'MCPEOF'
          {
            "mcpServers": {
              "context7": {
                "command": "npx",
                "args": ["-y", "@upstash/context7-mcp"]
              }
            }
          }
          MCPEOF
        env:
          CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        env:
          CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            BASE_SHA: ${{ github.event.pull_request.base.sha }}
            HEAD_SHA: ${{ github.event.pull_request.head.sha }}

            ## レビュー指示

            このPRを以下の観点でレビューしてください：

            ### 1. 基本的なコードレビュー
            - コード品質とベストプラクティス
            - 潜在的なバグや問題
            - パフォーマンスへの考慮
            - セキュリティ上の懸念
            - テストカバレッジ

            ### 2. ライブラリ・フレームワークの専門家視点
            **重要**: Context7 MCPツールを使用して、このPRで使用されているライブラリやフレームワークの最新ドキュメントを確認してください。
            - Next.js, React, TypeScript, TailwindCSS など、変更に関連するライブラリの最新のベストプラクティスを確認
            - 非推奨のAPIや古いパターンが使われていないか確認
            - より良い実装方法がないか提案

            ### 3. プロジェクトドキュメントとの整合性確認
            `.kiro/steering/` 配下のドキュメントを確認し、PRの変更との整合性をチェックしてください：
            - `product.md`: プロダクト概要との整合性
            - `tech.md`: 技術スタック規約との整合性
            - `structure.md`: プロジェクト構造規約との整合性
            - `database.md`: データベース規約との整合性
            - `design.md`: デザインシステム規約との整合性
            - `api-standards.md`: API設計規約との整合性
            - `testing.md`: テスト規約との整合性

            **矛盾がある場合**:
            - PRの実装が間違っているのか
            - ドキュメントの更新漏れなのか
            を判断して指摘してください。

            ### レビューコメントの出し方

            1. **インラインコメント**: 問題のある箇所には `gh api` を使用してインラインコメントを残してください。
               ```bash
               gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
                 -f body="コメント内容" \
                 -f commit_id="HEAD_SHA" \
                 -f path="ファイルパス" \
                 -F line=行番号 \
                 -f side="RIGHT"
               ```

            2. **総合レビューコメント**: 最後に `gh pr comment` でPR全体へのレビューサマリーを残してください。
               - 良い点
               - 改善が必要な点
               - ドキュメントとの整合性
               - 使用ライブラリの観点からの提案

            CLAUDE.mdとsteeringドキュメントを参照して、プロジェクトのスタイルと規約に従ってレビューしてください。

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
          claude_args: '--mcp-config /tmp/mcp-config.json --allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh api:*),mcp__context7__*"'
